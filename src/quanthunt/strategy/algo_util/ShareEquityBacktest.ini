# FundPool Lease Replay — Performance Panel Guide (Spec v1.0)

> 這份文件用來解釋你輸出的每個 **panel CSV**：  
> **目的是什麼、怎麼讀、各欄位常見值代表什麼意思**。  
> 你以後做 performance review 一律照本文件走，避免 report 混在一起造成誤判。

---

## 0) 讀報表的固定順序（不要跳）

1. `run_meta.csv`  
   → 先確認「我在看哪一個世界」
2. `outcome_summary.csv`  
   → 值不值得繼續看
3. `execution_timeseries.csv`  
   → 是策略輸，還是被錢/限制卡住
4. `selection_quality.csv`  
   → rule 有沒有資訊量（是否真的比 random 好）
5. `risk_structure.csv`  
   → 如果錯，會不會同步錯到爆

---

# Panel 0 — `run_meta.csv`（Run Identity）

## 目的
> **只做一件事：防止你把不同實驗混在一起比較。**

你所有的比較（INIT_CASH / STAKE / K_PER_TICK / selector / feature）都必須先對齊這份 meta。

## 欄位解讀

- `run_id`：這次 run 的唯一識別（時間戳）
- `data_dir` / `out_dir`：資料來源/輸出位置
- `start_date` / `end_date`：回測時間範圍
- `INIT_CASH`：起始資金（capacity 決定因素）
- `STAKE`：單筆下注金額（單筆 unit risk）
- `K_PER_TICK`：同一 entry time 最多採納數（你的人為上限）
- `selector_rule_feature`：rule 實際使用的 feature（例如 `m_regime_noise_level`）
- `universe_size`：標的數
- `pool_rows`：候選池總筆數

## 例子（看懂這份就不會亂比較）

### ✅ 例 1：兩次 run 可以比較（同一世界）
- INIT_CASH 相同、STAKE 相同、K 相同、start/end 相同，只差 ATR / feature
→ 可以比較 outcome & execution

### ❌ 例 2：兩次 run 不能直接比較（不同世界）
- A：INIT_CASH=5000、STAKE=100
- B：INIT_CASH=20000、STAKE=100
→ B 的 coverage/收益提升可能只是 capacity 解鎖，不代表策略更好

---

# Panel 1 — `outcome_summary.csv`（Outcome Panel）

## 目的
> **回答唯一問題：這個 run 值不值得研究？**  
> （Outcome 不過關，其他 panel 全部不用看）

## 欄位
- `selector`：`random` 或 `rule`
- `rule_feature`：rule 使用的 feature（random 可能是 None）
- `final_equity`：期末權益（帳面）
- `max_dd`：最大回撤（負值）
- `median_profit`：單筆 profit 的中位數（用於判斷是否靠尾巴）
- `ticks`：時間點數（樣本長度）

## 怎麼讀（核心判讀）

### 1) `final_equity`
- 越大越好，但 **不能單獨看**
- 必須搭配 max_dd / median_profit / ticks

**例子：**
- final_equity=40000：看起來爆炸強  
  → 先看 max_dd 是否能接受，再看 median_profit 是否為正

### 2) `max_dd`（最大回撤）
- `-0.05 ~ -0.15`：健康、可放大
- `-0.15 ~ -0.30`：中等，需看你能不能扛
- `< -0.30`：高風險，先看 risk_structure 再談加大資金

**例子：**
- max_dd=-0.10：可以往「增加 coverage」方向探索（加資金/放寬限制）
- max_dd=-0.35：即使賺錢，也可能是尾巴+集中暴露，先別放大

### 3) `median_profit`
> **判斷你是不是靠“少數大贏”活著**

- `> 0`：多數交易是賺的（流程型 alpha）
- `≈ 0`：接近公平，可能靠運氣或摩擦成本不利
- `< 0`：多數交易虧，靠尾巴把平均拉起（極危險）

**例子：**
- median_profit=+0.012：很強，代表大部分交易有正期望
- median_profit=-0.005：即使 final_equity 高，也可能是少數巨贏撐起來

### 4) `ticks`
- ticks 太低 → 統計不穩
- ticks 很高 → 你比較能相信 median_profit / dd 結構

---

# Panel 2 — `execution_timeseries.csv`（Execution / Capacity Panel）

## 目的
> **回答：你輸的是策略，還是輸在執行不完全（capacity bottleneck）？**

這份是你目前系統最關鍵的面板，因為你的策略是「機會過剩」型。

## 欄位
- `time`：entry time
- `available_cash`：可用資金
- `active_leases`：當下持倉數
- `n_candidates`：當下候選數（HMM1 + Buy1）
- `n_accepted`：當下實際採納數（受 STAKE/現金限制）
- `n_rejected_cash`：被錢拒絕的比例（你現在存的是 ratio）
- `coverage_ratio`：`n_accepted / n_candidates`
- `equity`：帳面權益（可用 + 鎖住本金）
- `drawdown`：回撤

## 核心概念：Coverage 與 Capacity

### A) `coverage_ratio`（信號覆蓋率）
- `≈ 1.0`：你幾乎吃到所有機會（完整執行）
- `0.6 ~ 0.9`：部分卡住（要看是否在關鍵趨勢期卡住）
- `< 0.6`：嚴重 capacity 限制，你看到的不是策略真身

**例子：**
- 某段時間 coverage_ratio 長期 0.35  
  → 你其實在「明明有 10 個好機會，只能吃 3 個」的狀態  
  → 如果後期 coverage 突然變 0.9，這就是你說的「暴漲相變」

### B) `n_rejected_cash`
- `≈ 0`：錢足夠
- 長期偏高：表示你常常遇到“想買但沒錢”的狀況

**例子：**
- n_candidates=6, n_accepted=3 → coverage=0.5  
  → 若 n_rejected_cash 同時偏高，表示 **錢不夠**  
  → 若 n_rejected_cash 低但 coverage 還低，可能是你 K_PER_TICK 限制（人為瓶頸）

### C) `active_leases`
這是「資金佔用率」的 proxy

- 長期接近你理論上限（INIT_CASH/STAKE）：  
  → 市場機會密度高，你系統在滿負載跑
- 長期偏低：  
  → 可能市場沒機會；或你的 entry 條件太嚴；或你 K 太小

**例子：**
- INIT_CASH=5000, STAKE=100 → 理論最多 50 筆  
  如果 active_leases 長期 45~50：你一直滿倉  
  如果 active_leases 常常 < 10：你其實沒在做事（或機會密度很低）

### D) `available_cash`
- 長期接近 0：你幾乎一直把錢用完 → 可能收益高，但也可能風險集中
- 長期很高：錢常閒置 → 可能配置太保守 / 信號太少 / K 太小

---

# Panel 3 — `selection_quality.csv`（Selection Quality Panel）

## 目的
> **回答：你在橫截面選的那些（picked），是否真的比沒選的（dropped）好？**  
> 這份 panel 不看 equity，因為它要 isolate 「選擇品質」。

## 欄位
- `Date`：當日 entry time
- `feature`：用來排序/選擇的特徵（例如 `m_regime_noise_level`）
- `pairwise_hit`：picked 的 profit 是否大於 dropped 的 pairwise 機率（0~1）
- `rolling_pairwise_hit`：20 期 rolling 平滑
- `n_pick` / `n_drop` / `n_candidates`：當日的樣本數
- `m_regime_noise_level`：當日 noise 的代表值（你目前用 median）

## 核心指標：pairwise_hit

### A) `pairwise_hit` 的語義
> picked 的每一筆 profit，跟 dropped 每一筆比，勝率是多少

- `0.50`：跟亂選差不多（無資訊量）
- `0.52 ~ 0.55`：弱優勢（長期仍可放大）
- `0.55 ~ 0.62`：明顯優勢（很強）
- `> 0.62`：異常強，注意是否過擬合/樣本偏誤

**例子：**
- pairwise_hit=0.58  
  → 你選的那幾筆，有 58% 的機率比沒選的更賺  
  → rule 有資訊量

- pairwise_hit=0.49  
  → 你選的還不如沒選的  
  → 這不是 capacity 問題，是選擇邏輯問題（或 feature 壞了）

### B) `rolling_pairwise_hit`
- 長期穩定 > 0.53：選擇邏輯穩健
- 會突然跌到 0.5 以下：可能 regime 變了 / feature 失效

**例子：**
- rolling 長期 0.56，但在高 noise 時跌到 0.51  
  → 代表 rule 只在乾淨狀態好用  
  → 你可以把 rule 條件做成 regime dependent（下一步）

### C) `n_candidates` 太小時怎麼看
- n_candidates < 3：pairwise_hit 可信度低（樣本太小）
- n_candidates 很大：pairwise_hit 更可信

---

# Panel 4 — `risk_structure.csv`（Risk Structure Panel, minimal v1）

## 目的
> **回答：如果錯，會不會同步錯到爆？**  
> 這份用來做風險預算，而不是調 entry。

## 欄位（minimal v1）
- `max_concurrent_positions`：最大同時持倉
- `avg_concurrent_positions`：平均同時持倉
- `p95_drawdown`：回撤的 5% 分位（尾部回撤 proxy）
- `p99_drawdown`：回撤的 1% 分位（更極端尾部）
- `min_cash`：最小可用現金（是否常常乾到 0）

## 解讀（你要用它來決定“放不放大”）

### A) `max_concurrent_positions`
- 很高：表示某些時段你滿倉、滿負載  
  → 收益引擎可能很強  
  → 但也可能暴露集中（下一版會補 exposure_by_symbol）

### B) `p95_drawdown / p99_drawdown`
這兩個是「尾部痛感」。

- p95_drawdown 接近 0：大部分時間很平滑
- p99_drawdown 很差：偶爾會有一次深回撤（你必須問自己扛不扛）

**例子：**
- p95=-0.05, p99=-0.20  
  → 平常很舒服，但極端時會一次打很深  
  → 需要風險預算或 stop mechanism

- p95=-0.12, p99=-0.15  
  → 大部分時間都痛，但不會爆炸（慢性病型）

### C) `min_cash`
- min_cash ≈ 0：你很多時候把錢用乾  
  → 可能造成 coverage 降低（execution panel 要對照）  
  → 也可能代表你在用完 capacity（取決於是否一直賺）

---

# 常見誤判與防呆規則（必讀）

## 誤判 1：Outcome 好就以為策略好
- 可能只是 capacity 解鎖或尾巴年份
- 必須看 `selection_quality.csv` 的 rolling_pairwise_hit 是否 > 0.5

## 誤判 2：Coverage 低就加錢
- 先看 selection 有沒有資訊量  
  若 pairwise_hit ≈ 0.5，錢越多只是放大噪音

## 誤判 3：回撤大就把 K 限制死
- 你應該限制的是「風險暴露維度」（同標的/同因子），不是限制交易數  
  （risk_structure 下一版會升級到 exposure_by_symbol）

---

# 你下一步最常用的三個決策模板（直接照做）

## 模板 A：判斷是不是錢卡住（capacity issue）
1. 看 execution 的 coverage_ratio 是否長期 < 0.7
2. 看 n_rejected_cash 是否長期偏高
3. 若是 → 調 INIT_CASH 或 STAKE（或放寬 K）

## 模板 B：判斷 rule 是否真的有效（alpha issue）
1. 看 selection 的 rolling_pairwise_hit 是否長期 > 0.53
2. 若否 → 不要調資金，不要調 K  
   先改 feature / rule / regime 條件

## 模板 C：判斷能不能放大（risk issue）
1. outcome 看 max_dd 是否可接受
2. risk 看 p99_drawdown 是否會讓你爆炸
3. 若 risk 太大 → 做風險預算（不是砍掉 coverage）

---

# 附：欄位值範圍快速對照（速查表）

## coverage_ratio
- 0.0~0.3：嚴重卡住
- 0.3~0.7：部分卡住
- 0.7~0.9：接近完整
- 0.9~1.0：完整執行

## pairwise_hit / rolling_pairwise_hit
- < 0.50：選擇在害你
- 0.50~0.52：無優勢
- 0.52~0.55：小優勢
- 0.55~0.62：強優勢
- > 0.62：強到不正常，注意樣本/過擬合

## max_dd
- -0.05~-0.15：健康
- -0.15~-0.30：可接受但要控風險
- < -0.30：高危，需要風險預算/止血機制

---

# 最後一句（給未來的你）

> **Outcome 只告訴你結果，  
Execution 告訴你是不是被卡住，  
Selection 告訴你有沒有 alpha，  
Risk 告訴你會不會死。**  
> **不要讓它們互相污染。**
